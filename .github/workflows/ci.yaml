name: CI
on:
  pull_request:
    branches: [main]
# Cancel in-progress runs for pull requests when developers push new changes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
jobs:
  test-terraform:
    name: Validate Terraform output
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: shell
          filters: |
            shared:
              - 'test/**'
              - 'package.json'
              - 'bun.lock'
              - 'bunfig.toml'
              - 'tsconfig.json'
              - '.github/workflows/ci.yaml'
              - 'scripts/ts_test_auto.sh'
              - 'scripts/terraform_test_all.sh'
              - 'scripts/terraform_validate.sh'
              - 'scripts/shellcheck_validate.sh'
            modules:
              - 'registry/**/modules/**'
            shell:
              - '**/*.sh'
            all:
              - '**'
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Run TypeScript tests
        env:
          ALL_CHANGED_FILES: ${{ steps.filter.outputs.all_files }}
          SHARED_CHANGED: ${{ steps.filter.outputs.shared }}
          MODULE_CHANGED_FILES: ${{ steps.filter.outputs.modules_files }}
        run: bun tstest
      - name: Run Terraform tests
        env:
          ALL_CHANGED_FILES: ${{ steps.filter.outputs.all_files }}
          SHARED_CHANGED: ${{ steps.filter.outputs.shared }}
          MODULE_CHANGED_FILES: ${{ steps.filter.outputs.modules_files }}
        run: bun tftest
      - name: Run Terraform Validate
        env:
          ALL_CHANGED_FILES: ${{ steps.filter.outputs.all_files }}
          SHARED_CHANGED: ${{ steps.filter.outputs.shared }}
          MODULE_CHANGED_FILES: ${{ steps.filter.outputs.modules_files }}
        run: bun terraform-validate
      - name: Run ShellCheck
        env:
          ALL_CHANGED_FILES: ${{ steps.filter.outputs.all_files }}
          SHARED_CHANGED: ${{ steps.filter.outputs.shared }}
          SHELL_CHANGED_FILES: ${{ steps.filter.outputs.shell_files }}
        run: bun shellcheck
      - name: Validate set -u ordering
        run: ./scripts/validate_set_u_order.sh
  validate-style:
    name: Check for typos and unformatted code
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      # Need Terraform for its formatter
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
      - name: Install dependencies
        run: bun install
      - name: Validate formatting
        run: bun fmt:ci
      - name: Check for typos
        uses: crate-ci/typos@v1.43.4
        with:
          config: .github/typos.toml
  validate-readme-files:
    name: Validate README files
    runs-on: ubuntu-latest
    # We want to do some basic README checks first before we try analyzing the
    # contents
    needs: validate-style
    steps:
      - name: Check out code
        uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.0"
      - name: Validate contributors
        run: go build ./cmd/readmevalidation && ./readmevalidation
      - name: Remove build file artifact
        run: rm ./readmevalidation
